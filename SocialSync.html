<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SocialSync</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts (FIXED) -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { box-sizing: border-box; }
    * { font-family: 'DM Sans', sans-serif; }
    .title-font { font-family: 'Space Grotesk', sans-serif; }

    .gradient-bg {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0f9ff 100%);
    }

    .card-gradient {
      background: linear-gradient(145deg, rgba(255,255,255,.95), rgba(248,250,252,.98));
      backdrop-filter: blur(10px);
    }

    .accent-gradient { background: #3b82f6; }

    .input-style {
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(203,213,225,.5);
      transition: .3s;
    }

    .input-style:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,.2);
      outline: none;
      background: white;
    }

    .btn-primary {
      background: #3b82f6;
      transition: .3s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 40px rgba(59,130,246,.3);
    }

    .checkbox-custom { accent-color: #3b82f6; }
    .section-btn { cursor: pointer; user-select: none; }
    .section-btn:hover { transform: translateY(-2px); }
  </style>
</head>

<body class="h-full gradient-bg text-slate-800">
<div id="app" class="h-full flex flex-col overflow-hidden">

<!-- HEADER -->
<header class="px-6 py-4 border-b bg-white/50 backdrop-blur">
  <div class="max-w-7xl mx-auto flex justify-between items-center">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 accent-gradient rounded-xl flex items-center justify-center text-white font-bold">SS</div>
      <div>
        <h1 class="title-font text-xl font-bold text-blue-600">SocialSync</h1>
        <p class="text-xs text-slate-600">Event & Programme Management System</p>
      </div>
    </div>

    <div class="flex items-center gap-4 text-sm">
      <span id="record-count">Loading...</span>
      <button id="print-btn" class="px-4 py-2 bg-blue-100 rounded-lg no-print">Print</button>
      <button id="view-records-btn" class="px-4 py-2 bg-slate-100 rounded-lg no-print">View Records</button>
    </div>
  </div>
</header>

<!-- MAIN -->
<main class="flex-1 overflow-auto p-6">
<div class="max-w-6xl mx-auto">

<!-- SECTION SELECT -->
<div class="bg-white rounded-xl p-6 mb-6 border">
  <h2 class="title-font text-lg font-semibold mb-4 text-blue-600">Select Report Type</h2>
  <div class="grid md:grid-cols-3 gap-4">
    <button class="section-btn p-4 border rounded-lg" data-section="ip2m1-1">BULETIN DAERAH</button>
    <button class="section-btn p-4 border rounded-lg" data-section="ip2m1-2">IP2M1</button>
    <button class="section-btn p-4 border rounded-lg" data-section="ip3m2">IP3M2</button>
  </div>
</div>

<form id="main-form" class="card-gradient rounded-xl border hidden">

<!-- PROGRAMME INFO -->
<div class="p-6 border-b">
  <h2 class="title-font text-lg font-semibold mb-4 text-blue-600">Programme Information</h2>

  <div class="grid md:grid-cols-3 gap-4">
    <select id="daerah-dropdown" class="input-style px-4 py-3 rounded-lg">
      <option value="">-- Pilih Daerah --</option>
      <option value="Pejabat Residen Bahagian Mukah">Pejabat Residen Bahagian Mukah</option>
      <option value="Pejabat Daerah Mukah">Pejabat Daerah Mukah</option>
      <option value="Pejabat Daerah Dalat">Pejabat Daerah Dalat</option>
      <option value="Pejabat Daerah Matu">Pejabat Daerah Matu</option>
      <option value="Pejabat Daerah Daro">Pejabat Daerah Daro</option>
    </select>

    <input id="programme" class="input-style px-4 py-3 rounded-lg" placeholder="Programme Name" required>
    <input type="date" id="date" class="input-style px-4 py-3 rounded-lg">
    <input id="organizer" class="input-style px-4 py-3 rounded-lg" placeholder="Organizer">
  </div>
</div>

<!-- BULETIN DAERAH -->
<div id="section-ip2m1-1" class="hidden p-6 space-y-4">
  <textarea id="ip1-tempat" rows="2" class="input-style w-full px-4 py-3 rounded-lg" placeholder="Tempat & Kapasiti"></textarea>
  <textarea id="ip1-deskripsi" rows="2" class="input-style w-full px-4 py-3 rounded-lg" placeholder="Deskripsi Program"></textarea>
  <textarea id="ip1-objektif" rows="2" class="input-style w-full px-4 py-3 rounded-lg" placeholder="Objektif"></textarea>
  <textarea id="ip1-impak" rows="2" class="input-style w-full px-4 py-3 rounded-lg" placeholder="Impak Program"></textarea>

  <input type="number" id="ip1-bil-tetamu" class="input-style w-full px-4 py-3 rounded-lg" placeholder="Bilangan Tetamu">
  <textarea id="ip1-pihak-media" rows="2" class="input-style w-full px-4 py-3 rounded-lg" placeholder="Pihak Media"></textarea>

  <input type="file" id="ip2m1-1-images" multiple accept="image/*" class="input-style px-4 py-2 rounded-lg">
</div>

<!-- IP2M1 -->
<div id="section-ip2m1-2" class="hidden p-6 space-y-4">
  <input type="file" id="supporting-docs-pdf" multiple accept=".pdf" class="input-style px-4 py-2 rounded-lg">
  <input type="file" id="ip2m1-2-images" multiple accept="image/*" class="input-style px-4 py-2 rounded-lg">
</div>

<!-- IP3M2 -->
<div id="section-ip3m2" class="hidden p-6 space-y-4">
  <input type="file" id="ip3m2-images" multiple accept="image/*" class="input-style px-4 py-2 rounded-lg">
</div>

</form>
</div>
</main>
</div>
</body>
</html>

<!-- Submit Button -->
<div class="p-6 border-t border-slate-200">
  <button type="submit" id="submit-btn"
    class="w-full btn-primary py-4 rounded-xl font-semibold text-white flex items-center justify-center gap-2 no-print">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
    </svg>
    <span>Submit Report</span>
  </button>
</div>
</form>
</div>
</main>
</div>

<script>
/* =========================
   UTIL
========================= */
function num(v) {
  const n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}

/* =========================
   IP2M1:2 CALCULATION
========================= */
function updateIP2M1_2() {
  const checks = [
    document.getElementById('media-cetak-checkbox')?.checked,
    document.getElementById('media-elektronik-checkbox')?.checked,
    document.getElementById('media-digital-checkbox')?.checked
  ].filter(Boolean).length;

  let mediaCoverage = 0;
  if (checks === 1) mediaCoverage = 80;
  else if (checks === 2) mediaCoverage = 90;
  else if (checks >= 3) mediaCoverage = 100;

  document.getElementById('media-coverage').textContent = mediaCoverage + '%';

  const crowd = num(document.getElementById('crowd-size').value);
  const target = num(document.getElementById('target-group').value);
  const percent = target > 0 ? Math.min(100, (crowd / target) * 100) : 0;

  document.getElementById('survey-percent-display').textContent = percent.toFixed(1) + '%';
  document.getElementById('participant-percent').textContent = percent.toFixed(1) + '%';

  const total = (mediaCoverage + percent + percent) / 3;
  document.getElementById('total-ip2m1-2').textContent = total.toFixed(1);
}

/* =========================
   IP3M2 CALCULATION
========================= */
function updateIP3M2() {
  const list = document.getElementById('ip3-media-list').value.trim();
  const count = list ? list.split(/\r?\n/).filter(l => l.trim()).length : 0;
  document.getElementById('ip3-media-percent').textContent = (count >= 3 ? 100 : 0) + '%';

  const actual = num(document.getElementById('ip3-actual-attendance').value);
  const target = num(document.getElementById('ip3-target-attendance').value);
  document.getElementById('ip3-participation-percent').textContent =
    (target ? Math.min(100, (actual / target) * 100) : 0).toFixed(1) + '%';

  const total = num(document.getElementById('ip3-total-respondent').value);
  const positive = num(document.getElementById('ip3-positive-respondent').value);
  document.getElementById('ip3-satisfaction-percent').textContent =
    (total ? (positive / total) * 100 : 0).toFixed(1) + '%';

  const revenue = num(document.getElementById('ip3-revenue').value);
  const modal = num(document.getElementById('ip3-modal').value);
  const roi = modal > 0 ? ((revenue - modal) / modal) * 100 : 0;
  document.getElementById('ip3-roi-percent').textContent = roi.toFixed(1) + '%';
}

/* =========================
   BASE64
========================= */
function fileToBase64(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res({
      name: file.name,
      mimeType: file.type,
      data: r.result.split(',')[1]
    });
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

/* =========================
   RECORD COUNT
========================= */
async function fetchRecordCount() {
  try {
    const res = await fetch(WEB_APP_URL + '?count=1');
    const data = await res.json();
    document.getElementById('record-count').textContent = `${data.count} Records`;
  } catch {
    document.getElementById('record-count').textContent = '0 Records';
  }
}

/* =========================
   SUBMIT
========================= */
const WEB_APP_URL =
  'https://script.google.com/macros/s/AKfycbz3bZAmOOP5N9wTSKjdA8WWAO4AAolYgWLy48M1Ivh-cRW4OdOcDFWd-GivXDPJg-6Rig/exec';

async function submitForm(e) {
  e.preventDefault();

  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.innerHTML = 'Saving...';

  try {
    const section = document.querySelector('.section-btn.border-cyan-400')?.dataset.section;
    if (!section) throw 'Select a report section';

    const imagesInput = document.getElementById(`${section}-images`)?.files || [];
    const images = [];
    for (const f of imagesInput) images.push(await fileToBase64(f));

    const pdfs = [];
    if (section === 'ip2m1-2') {
      for (const f of document.getElementById('supporting-docs-pdf').files)
        pdfs.push(await fileToBase64(f));
    }

    const payload = {
      formData: { section },
      images,
      pdfs
    };

    await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    alert('✅ Data saved successfully');
    document.getElementById('main-form').reset();
    fetchRecordCount();
    updateIP2M1_2();
    updateIP3M2();

  } catch (err) {
    alert('❌ ' + err);
    console.error(err);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Submit Report';
  }
}

/* =========================
   INIT
========================= */
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('main-form').addEventListener('submit', submitForm);

  ['media-cetak-checkbox','media-elektronik-checkbox','media-digital-checkbox','crowd-size','target-group']
    .forEach(id => document.getElementById(id)?.addEventListener('input', updateIP2M1_2));

  ['ip3-media-list','ip3-actual-attendance','ip3-target-attendance','ip3-total-respondent','ip3-positive-respondent','ip3-revenue','ip3-modal']
    .forEach(id => document.getElementById(id)?.addEventListener('input', updateIP3M2));

  fetchRecordCount();
  updateIP2M1_2();
  updateIP3M2();
});
</script>
